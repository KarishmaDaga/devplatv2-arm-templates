{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaceName": {
            "type": "String"
        },
        "location": {
            "type": "String"
        },
		"onlineEndpointName": {
            "defaultValue": "testonlineendpointGA",
            "type": "String"
        },
		"onlineDeploymentName": {
            "defaultValue": "testonlinedeploymentGA",
            "type": "String"
        },
        "onlineEndpointDescription": {
            "defaultValue": "This is an online endpoint deployment created by an ARM template",
            "type": "String"
        },
        "onlineDeploymentTags": {
            "defaultValue": {},
            "type": "Object"
        },
        "identityType": {
            "allowedValues": [
                "SystemAssigned",
                "UserAssigned"
            ],
            "type": "String"
        },
		"sku": {
			"type": "String"
		},
		"codeAssetName": {
			"type": "string"
		},
		"codeAssetVersion": {
			"type": "string",
			"defaultValue": "1"
		},
		"scoringScript": {
			"type": "string",
			"metadata": {
				"description": "The script to execute on startup. eg. 'score.py'"
			}
		},
		"environmentAssetName": {
			"type": "string"
		},
		"environmentAssetVersion": {
			"type": "string",
			"defaultValue": "1"
		},
		"appInsightsEnabled": {
			"type": "bool",
			"defaultValue": false
		},
		"endpointComputeType": {
			"type": "string",
			"allowedValues": [
				"Managed",
				"Kubernetes",
				"AzureMLCompute"
			]
		},
		"livenessProbeFailureThreshold": {
			"type": "int",
			"defaultValue": 30,
			"metadata": {
				"description": "The number of failures to allow before returning an unhealthy status."
			}
		},
		"livenessProbeSuccessThreshold": {
			"type": "int",
			"defaultValue": 1,
			"metadata": {
				"description": "The number of successful probes before returning a healthy status."
			}
		},
		"livenessProbeInitialDelay": {
			"type": "string",
			"defaultValue": "PT0S",
			"metadata": {
				"description": "The delay before the first probe in ISO 8601 format."
			}
		},
		"livenessProbePeriod": {
			"type": "string",
			"defaultValue": "PT10S",
			"metadata": {
				"description": "The length of time between probes in ISO 8601 format."
			}
		},
		"livenessProbeTimeout": {
			"type": "string",
			"defaultValue": "PT2S",
			"metadata": {
				"description": "The probe timeout in ISO 8601 format."
			}
		},
		"modelURI": {
			"type": "string",
			"defaultValue": "",
			"metadata": {
				"description": "The URI path to the model."
			}
		},
		"modelMountPath": {
			"type": "string",
			"defaultValue": "",
			"metadata": {
				"description": "The path to mount the model in custom container."
			}
		},
		"readinessProbeFailureThreshold": {
			"type": "int",
			"defaultValue": 30,
			"metadata": {
				"description": "The number of failures to allow before returning an unhealthy status."
			}
		},
		"readinessProbeSuccessThreshold": {
			"type": "int",
			"defaultValue": 1,
			"metadata": {
				"description": "The number of successful probes before returning a healthy status."
			}
		},
		"readinessProbeInitialDelay": {
			"type": "string",
			"defaultValue": "PT0S",
			"metadata": {
				"description": "The delay before the first probe in ISO 8601 format."
			}
		},
		"readinessProbePeriod": {
			"type": "string",
			"defaultValue": "PT10S",
			"metadata": {
				"description": "The length of time between probes in ISO 8601 format."
			}
		},
		"readinessProbeTimeout": {
			"type": "string",
			"defaultValue": "PT2S",
			"metadata": {
				"description": "The probe timeout in ISO 8601 format."
			}
		},
		"requestSettingsMaxConcurrentRequestsPerInstance": {
			"type": "int",
			"defaultValue": 1,
			"metadata": {
				"description": "The number of maximum concurrent requests per node allowed per deployment. Defaults to 1."
			}
		},
		"requestSettingsMaxQueueWait": {
			"type": "string",
			"defaultValue": "PT0.5S",
			"metadata": {
				"description": "The maximum amount of time a request will stay in the queue in ISO 8601 format. Defaults to 500ms."
			}
		},
		"requestSettingsTimeout": {
			"type": "string",
			"defaultValue": "PT5S",
			"metadata": {
				"description": "The scoring timeout in ISO 8601 format. Defaults to 5000ms"
			}
		},
		"scaleSettingsScaleType": {
			"type": "string",
			"allowedValues": [
				"Default",
        		"TargetUtilization",
				null
			]
		}
    },
	"variables": {
		"codeAssetResourceId": "[resourceId('Microsoft.MachineLearningServices/workspaces/codes/versions', parameters('workspaceName'), parameters('codeAssetName'), parameters('codeAssetVersion'))]",
		"environmentAssetResourceId": "[resourceId('Microsoft.MachineLearningServices/workspaces/environments/versions', parameters('workspaceName'), parameters('environmentAssetName'), parameters('environmentAssetVersion'))]"
	},
    "resources": [
        {
            "type": "Microsoft.MachineLearningServices/workspaces/onlineEndpoints",
            "apiVersion": "2021-10-01",
            "name": "[concat(parameters('workspaceName'), '/', parameters('onlineEndpointName'),'/', parameters('onlineDeploymentName'))]",
            "location": "[parameters('location')]",
            "tags": "[parameters('onlineDeploymentTags')]",
            "identity": {
                "type": "[parameters('identityType')]"
            },
			"kind": "[parameters('kind')]",
			"sku": "[parameters('sku')]",
			"properties": {
				"codeConfiguration": {
					"codeId": "[variables('codeAssetResourceId')]",
					"scoringScript": "[parameters('scoringScript')]"
				},
				"environmentId": "[variables('environmentAssetResourceId')]",
				"environmentVariables": {},
				"appInsightsEnabled": "[parameters('appInsightsEnabled')]",
				"endpointComputeType": "[parameters('endpointComputeType')]",
				"livenessProbe": {
					"failureThreshold": "[parameters('livenessProbeFailureThreshold')]",
					"initialDelay": "[parameters('livenessProbeInitialDelay')]",
					"period": "[parameters('livenessProbePeriod')]",
					"successThreshold": "[parameters('livenessProbeSuccessThreshold')]",
					"timeout": "[parameters('livenessProbeTimeout')]"
				},
				"model": "[parameters('modelURI')]",
				"modelMountPath": "[parameters('modelMountPath')]",
				"provisioningState": "Creating",
				"readinessProbe": {
					"failureThreshold": "[parameters('readinessProbeFailureThreshold')]",
					"initialDelay": "[parameters('readinessProbeInitialDelay')]",
					"period": "[parameters('readinessProbePeriod')]",
					"successThreshold": "[parameters('readinessProbeSuccessThreshold')]",
					"timeout": "[parameters('readinessProbeTimeout')]"
				},
				"requestSettings": {
					"maxConcurrentRequestsPerInstance": "[parameters('requestSettingsMaxConcurrentRequestsPerInstance')]",
					"maxQueueWait": "[parameters('requestSettingsMaxQueueWait')]",
					"requestTimeout": "[parameters('requestSettingsTimeout')]"
				},
				"scaleSettings": {
					"scaleType": "[parameters('scaleSettingsScaleType')]"
				}
			}
		}
	]
}
